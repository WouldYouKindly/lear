<!doctype html>
<html>

<head>
    <title>Lear</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.0.0/dist/abcjs-basic-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vexflow/build/cjs/vexflow.js"></script>
    <script type="module">
        import WhiteKey from './white-key.js';
        import PianoOctave from './piano-octave.js';
        import Questions from './questions.js';
        import { start, stop, playSequence } from './sound.js';
        import { nRandom, zip, range } from './utils.js';
        import { Staff } from './staff.js';
        import { StaffVex } from './staff-vex.js';
        import { generateQuestion } from './question-gen.js';
                
                
        if (!customElements.get('piano-octave')) {
            customElements.define('white-key', WhiteKey);
            customElements.define('piano-octave', PianoOctave);
            customElements.define('questions-row', Questions);
        } 

        const staff = new StaffVex("output");
        const staffAnswer = new StaffVex("staff-answer");

        const octaves = document.getElementsByTagName('piano-octave');
        const whiteKeys = document.getElementsByTagName('white-key');
        for (let octaveOrKey of [...octaves, ...whiteKeys]) {
            octaveOrKey.addEventListener("pianokeydown", evt => {
                const note = evt.detail;
                start(note);
                staff.add(note);
            });
            octaveOrKey.addEventListener("pianokeyup", evt => stop());
        }

        // So that I can press a note, move cursor away from the keyboard and then release. 
        // Without it, the note would keep going forever.
        document.onmouseup = stop;

        staff.render();

        function onKeyDown(event) {
            // TODO The latter probably won't work on Windows, need to add platform-aware Ctrl handling.
            if (event.key === "Backspace" || (event.key === 'z' && event.metaKey)) {
                staff.remove();
            } else if (event.key === " ") {
                event.preventDefault();
                ;
            }
        }

        window.onkeydown = onKeyDown;

        // Questions 
        let currentQuestion = null;
        let possibleRange;
        const nextButton = document.getElementById("button-next");
        const submitButton = document.getElementById("button-submit");
        const questionsRow = document.getElementsByTagName('questions-row')[0];

        const nextQuestion = () => {
            if (currentQuestion === null) {
                [possibleRange, currentQuestion] = generateQuestion(4);
                console.log('Question', currentQuestion);
                nextButton.innerText = "Repeat";
            }
            staff.clear();
            staffAnswer.clear();

            if (possibleRange.includes("A3") || possibleRange.includes("B3")) {
                octaves[0].setAttribute("data-octave", "3");
                octaves[1].setAttribute("data-octave", "4");
                whiteKeys[0].setAttribute("data-note-hint", "C5")
            } else {
                octaves[0].setAttribute("data-octave", "4");
                octaves[1].setAttribute("data-octave", "5");
                whiteKeys[0].setAttribute("data-note-hint", "C6")
            }

            playSequence(currentQuestion);
        }

        const compare = (question, answer) => {
            const numCorrect = zip(question, answer).filter(([a, b]) => a === b).length;
            const requiredForSemi = Math.ceil((question.length - 1) / 2)

            if (numCorrect == question.length){
                return "correct";
            } else if (numCorrect >= requiredForSemi) {
                return "semi-correct";
            } else {
                return "incorrect";
            }
        }

        const submit = () => {
            questionsRow.recordResult(compare(currentQuestion, staff.notes));
            staffAnswer.add(...currentQuestion);
            currentQuestion = null;
            nextButton.innerText = "Next";            
        }

        nextButton.onclick = nextQuestion;
        submitButton.onclick = submit;

    </script>

    <style>
        #piano {
            display: flex;
            justify-content: center;
            position: relative;
        }
        #next {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        #next > button {
            width: 100px;
            height: 50px;
            margin-left: 15px;
        }
        .staff-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <questions-row></questions-row>

    <div class="staff-wrapper" id="output"></div>
    <div class="staff-wrapper" id="staff-answer"></div>

    <div id="next">
        <button id="button-next">Next</button>
        <button id="button-submit">Submit</button>
    </div>

    <div id="piano">
        <piano-octave data-octave="4"></piano-octave>
        <piano-octave data-octave="5"></piano-octave>
        <white-key data-note-hint="C6" data-standalone="true"></white-key>
    </div>
</body>

</html>
<!doctype html>
<html>

<head>
    <title>Lear</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/abcjs@6.0.0/dist/abcjs-basic-min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/vexflow/build/cjs/vexflow.js"></script>
    <script type="module">
        import WhiteKey from './white-key.js';
        import BlackKey from './black-key.js';
        import PianoOctave from './piano-octave.js';
        import Questions from './questions.js';
        import { start, stop, playSequence } from './sound.js';
        import { nRandom, zip, range } from './utils.js';
        import { Staff } from './staff-vex.js';
        import { generateQuestion } from './question-gen.js';
        import { Database } from './db.js';

        const numQuestions = 3;
        const db = await Database.open();
        let currentSession = await db.getLastSession() || await db.createSession(numQuestions);
        const questions = await db.getQuestions(currentSession.pk);

        if (!customElements.get('piano-octave')) {
            customElements.define('white-key', WhiteKey);
            customElements.define('black-key', BlackKey);
            customElements.define('piano-octave', PianoOctave);
            customElements.define('questions-row', Questions);
        } 

        const staff = new Staff("output");
        const staffAnswer = new Staff("staff-answer");

        document.addEventListener("pianokeydown", evt => {
            const note = evt.detail;
            start(note);
            staff.add(note);
        });
        document.addEventListener("pianokeyup", evt => stop());
        
        // So that I can press a note, move cursor away from the keyboard and then release. 
        // Without it, the note would keep going forever.
        document.onmouseup = stop;

        function onKeyDown(event) {
            // TODO The latter probably won't work on Windows, need to add platform-aware Ctrl handling.
            if (event.key === "Backspace" || (event.key === 'z' && event.metaKey)) {
                staff.remove();
            } else if (event.key === " ") {
                event.preventDefault();
            }
        }

        window.onkeydown = onKeyDown;

        // Questions 
        let currentQuestion = null;
        let possibleRange;
        const nextRepeatButton = document.getElementById("button-next-repeat");
        const submitButton = document.getElementById("button-submit");
        const questionsRow = document.getElementsByTagName('questions-row')[0];
        questionsRow.update(questions);

        const nextQuestion = () => {
            if (questionsRow.allAnswered) {
                questionsRow.reset();
                currentSession = db.createSession(numQuestions);
            }

            [possibleRange, currentQuestion] = generateQuestion(4);
            console.log('Question', currentQuestion);
            nextRepeatButton.innerText = "Repeat";
            staff.clear();
            staffAnswer.clear();

            staff.addHint(currentQuestion[0]);
            
            const octaves = document.getElementsByTagName('piano-octave');
            const whiteKeys = document.getElementsByTagName('white-key');

            if (possibleRange.includes("A3") || possibleRange.includes("B3")) {
                octaves[0].setAttribute("data-octave", "3");
                octaves[1].setAttribute("data-octave", "4");
                whiteKeys[0].setAttribute("note", "C5");
            } else {
                octaves[0].setAttribute("data-octave", "4");
                octaves[1].setAttribute("data-octave", "5");
                whiteKeys[0].setAttribute("note", "C6");
            }
            
            return currentQuestion;
        }

        nextRepeatButton.onclick = () => {
            if (!currentQuestion) {
                currentQuestion = nextQuestion();
            }
            playSequence(currentQuestion);
        };

        submitButton.onclick = () => {
            staffAnswer.add(...currentQuestion);
            db.saveQuestion(currentSession.pk, currentQuestion, staff.notes);
            questionsRow.recordResult(currentQuestion, staff.notes);

            currentQuestion = null;
            nextRepeatButton.innerText = "Next";
        }

        staff.render();
    </script>

    <style>
        #piano {
            display: flex;
            justify-content: center;
            position: relative;
        }
        #next {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
        }
        #next > button {
            width: 100px;
            height: 50px;
            margin-left: 15px;
        }
        .staff-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <questions-row n="3"></questions-row>

    <div class="staff-wrapper" id="output"></div>
    <div class="staff-wrapper" id="staff-answer"></div>

    <div id="next">
        <button id="button-next-repeat">Next</button>
        <button id="button-submit">Submit</button>
    </div>

    <div id="piano">
        <piano-octave data-octave="4"></piano-octave>
        <piano-octave data-octave="5"></piano-octave>
        <white-key note="C6" show-note-hint="true"></white-key>
    </div>
</body>

</html>
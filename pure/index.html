<!doctype html>
<html>

<head>
    <title>Lear</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/abcjs@6.0.0/dist/abcjs-basic-min.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/vexflow/build/cjs/vexflow.js"></script>
    <script type="module">
        import WhiteKey from './white-key.js';
        import BlackKey from './black-key.js';
        import PianoOctave from './piano-octave.js';
        import Questions from './questions.js';
        import { start, stop, playSequence } from './sound.js';
        import { nRandom, zip, range } from './utils.js';
        import { Staff } from './staff-vex.js';
        import { generateQuestion } from './question-gen.js';
        import { Database } from './db.js';

        const numQuestions = 3;
        const db = await Database.open();
        let currentSession = await db.getLastSession() || await db.createSession(numQuestions);
        const questions = await db.getQuestions(currentSession.pk);

        if (!customElements.get('piano-octave')) {
            customElements.define('white-key', WhiteKey);
            customElements.define('black-key', BlackKey);
            customElements.define('piano-octave', PianoOctave);
            customElements.define('questions-row', Questions);
        } 

        window.pianoPlaying = null;

        const staff = new Staff("output");
        const staffAnswer = new Staff("staff-answer");

        document.addEventListener("pianokeydown", evt => {
            const {key, note} = evt.detail;
            start(note);
            staff.add(note);
            console.log('r', key);
            window.pianoPlaying = key;
            window.pianoPlaying.setActiveClass();
        });
        document.addEventListener("pianokeyup", evt =>{ 
            stop();
            window.pianoPlaying.removeActiveClass();
            window.pianoPlaying = null;
        });

        document.addEventListener("pianokeyenter", evt => {
            if (window.pianoPlaying) {
                const {key, note} = evt.detail;
                if (key === window.pianoPlaying) return;
                window.pianoPlaying.removeActiveClass();
                window.pianoPlaying = key;
                start(note);  // Automatically stops the previous note.
            }
        });
        
        // So that I can press a note, move cursor away from the keyboard and then release. 
        // Without it, the note would keep going forever.
        document.onmouseup = () => {
            stop();
            if (window.pianoPlaying) {
                window.pianoPlaying.removeActiveClass();
                window.pianoPlaying = null;
            }
        };

        function onKeyDown(event) {
            // TODO The latter probably won't work on Windows, need to add platform-aware Ctrl handling.
            if (event.key === "Backspace" || (event.key === 'z' && event.metaKey)) {
                // Don't allow erasing after the question is answered.
                if (!currentQuestion) return;
                
                staff.remove();
                if (staff.empty && currentQuestion) {
                    staff.addHint(currentQuestion[0]);
                }
            } else if (event.key === " ") {
                event.preventDefault();
            }
        }

        window.onkeydown = onKeyDown;

        // Questions 
        let currentQuestion = null;
        let possibleRange;
        const nextSubmitButton = document.getElementById("button-next-submit");
        const repeatButton = document.getElementById("button-repeat");
        const questionsRow = document.getElementsByTagName('questions-row')[0];
        questionsRow.update(questions);

        const nextQuestion = () => {
            if (questionsRow.allAnswered) {
                questionsRow.reset();
                currentSession = db.createSession(numQuestions);
            }

            [possibleRange, currentQuestion] = generateQuestion(4);
            console.log('Question', currentQuestion);
            nextSubmitButton.innerText = "Submit";
            staff.clear();
            staffAnswer.clear();

            staff.addHint(currentQuestion[0]);
            
            const octaves = document.getElementsByTagName('piano-octave');
            const whiteKeys = document.getElementsByTagName('white-key');

            if (possibleRange.includes("A3") || possibleRange.includes("B3")) {
                octaves[0].setAttribute("octave", "3");
                octaves[1].setAttribute("octave", "4");
                whiteKeys[0].setAttribute("note", "C5");
            } else {
                octaves[0].setAttribute("octave", "4");
                octaves[1].setAttribute("octave", "5");
                whiteKeys[0].setAttribute("note", "C6");
            }
            
            return currentQuestion;
        };

        nextSubmitButton.onclick = () => {
            if (!currentQuestion) {
                currentQuestion = nextQuestion();
                playSequence(currentQuestion);
            } else {
                staffAnswer.add(...currentQuestion);
                db.saveQuestion(currentSession.pk, currentQuestion, staff.notes);
                questionsRow.recordResult(currentQuestion, staff.notes);

                currentQuestion = null;
                nextSubmitButton.innerText = "Next";
            }
        };

        repeatButton.onclick = () => {
            if (currentQuestion) {
                playSequence(currentQuestion);
            }
        };

        staff.render();
    </script>

    <style>
        #piano {
            display: flex;
            justify-content: center;
            position: relative;
        }
        #next {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        #next > button {
            width: 100px;
            height: 50px;
            margin-left: 15px;
        }
        .staff-wrapper {
            display: flex;
            justify-content: center;
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <questions-row n="15"></questions-row>

    <div class="staff-wrapper" id="output"></div>
    <div class="staff-wrapper" id="staff-answer"></div>

    <div id="next">
        <button id="button-next-submit">Next</button>
        <button id="button-repeat">Repeat</button>
    </div>

    <div id="piano">
        <piano-octave octave="4"></piano-octave>
        <piano-octave octave="5"></piano-octave>
        <white-key note="C6" show-note-hint="true"></white-key>
    </div>
</body>

</html>